<% include header %>
  <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
  <div ng-app="App" ng-controller="AppCtrl">
    <div class="row">
      <h1>What is Coworking?</h1>
      <hr/>
      <p>
        The idea is simple: independent professionals and those with workplace
        flexibility work better together than they do alone. Coworking spaces are
        about community-building and sustainability. Participants agree to uphold
        the values set forth by the movementâ€™s founders, as well as interact and share 
        with one another. We are about creating better places to work and as a result,
        a better way to work.
      </p>

      <p>If your cowork location isn't represented, reach out to any of our <a href="#coordinators">coordinators</a> via Twitter, and they'll get the ball rolling.</p>
    </div>

    <% function cityString(city) {
        if(city.state) {
          return city.city + ", " + (city.state || "(none)") + ", " + city.country;
        } else {
          return city.city + ", " + city.country;
        }
    }%>

    <% u.each(all, function(city) {
      u.each(city.locations, function(loc) {
        loc.order = Math.random();
      });
    }); %>

    <div class="row">
      <div class="columns">
        <hr />
        Cities |
        <% u.each(all, function(city) {  %>
          <a href="#<%= city.tinyname || city.id %>_anchor">
            <%= cityString(city) %>
          </a> | 
        <% }); %>
        <hr />
      </div>
    </div>
    <br/>
    <br/>

    <% u.each(all, function(city) {  %>
      <div class="row" style="margin-bottom: 25px; padding-top: 5px; padding-bottom: 5px;">
        <div class="columns large-10 medium-10 small-10">
          <a href="#" id="<%= city.tinyname || city.id %>_anchor"> </a>
          <span style="font-size: 25px;"><%= cityString(city) %></span>
          <div style="margin-top: 5px; margin-bottom: 5px;">
            <% if(city.coordinator) { %>
              <a style="font-size: 15px" href="http://twitter.com/<%= city.coordinator %>">Contact @<%= city.coordinator %> via Twitter to add your cowork location</a>
            <% } %>
          </div>
        </div>
        <div class="columns large-2 medium-2 hide-for-small-only">
          <a class="button small viewmap" style="width: 100%; margin-bottom: 10px; padding: 10px; margin-right: 5px;" data-city-id="<%= city.id %>">view map</a>
        </div>

        <div class="columns large-12 small-12">
          <hr style="margin-top: 0px" />
        </div>

        <div class="columns">
          <% u.each(u.sortBy(city.locations, function(loc) { return loc.order; }), function(loc) {  %>
            <div style="margin-bottom: 10px;">
              <h4><a href="<%= loc.url %>" target="_blank"><%= loc.name %></a></h4>
              <%= loc.address || "" %>
            </div>
          <% }); %>
        </div>
      </div>
    <% }); %>

    <div class="row">
      <a href="#" id="coordinators"> </a>
      <h2>Our Coordinators</h2>
      <hr/>
    </div>

    <div class="row">
      <div class="columns" ng-repeat="coordinator in coordinators | orderBy:random" style="margin-bottom: 25px;">
        <img style="border: solid 1px silver; padding: 3px; float: right; width: 75px; height: 75px; margin-left: 20px;" src="{{coordinator.profile_image_url}}" />
        <div style="font-size: 20px">
          <span style="font-weight: bold">
            {{coordinator.name}} - <a href="http://twitter.com/{{coordinator.screen_name}}" target="_blank">@{{coordinator.screen_name}}</a><br/>
          </span>
          <br/>
          {{coordinator.description}}<br/>
        </div>
        <hr />
      </div>
    </div>
  </div>

  <script>
    var all = <%- JSON.stringify(all) %>;

    $(function() {
      $(".viewmap").click(function() {
        viewMap($(this).attr("data-city-id"));
      });
    });

    function viewMap(id) {
      var city = all[id];
      $("#map").html('');
      $('#mapmodal').foundation('reveal', 'open');
      setTimeout(function() {
        drawMap(city.locations);
      }, 2000);
    };

    function drawMap(locations) {
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });

      var infowindow = new google.maps.InfoWindow();

      var LatLngList = [];

      for (i = 0; i < locations.length; i++) {  
        var loc = JSON.parse(JSON.stringify(locations[i]));
        if(loc.lat && loc.lng) {
          var marker = new google.maps.Marker({
            position: new google.maps.LatLng(loc.lat, loc.lng),
            map: map
          });

          LatLngList.push(marker.position);

          google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {
              var loc = locations[i];
              infowindow.setContent(loc.name + "<br/><a target='_blank' href='https://www.google.com/maps/place/" + loc.address + "'>" + loc.address + "</a>");
              infowindow.open(map, marker);
            }
          })(marker, i));
        }
      }

      var bounds = new google.maps.LatLngBounds ();

      for (var i = 0, LtLgLen = LatLngList.length; i < LtLgLen; i++) {
        bounds.extend (LatLngList[i]);
      }

      map.fitBounds(bounds);
    }

    var app = angular.module('App', []);

    app.controller("AppCtrl", function($scope, $http) {
        $scope.random = function(entity){
          return entity.order;
        };

        var getCoordinators = function() {
          $http.get("/coordinators").success(function(data) {
            _.each(data.users, function(u) {
              u.order = Math.random();
            });

            $scope.coordinators = data.users;
          });
        };

        getCoordinators();
    });
  </script>

  <div id="mapmodal" class="reveal-modal" data-reveal="data-reveal">
    <div id="map" style="margin: 30px; width: 90%; height: 530px;"></div>
    <a class="close-reveal-modal">&#215;</a>
  </div>

<% include footer %>
